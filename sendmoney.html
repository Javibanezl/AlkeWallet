<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Alke Wallet - Enviar</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="css/styles.css">
    <style>
        .contact-item { cursor: pointer; transition: 0.2s; border: 1px solid #dee2e6; }
        .contact-item:hover { background-color: #f8f9fa; }
        .contact-item.selected { background-color: #e7f1ff; border-color: #0d6efd; }
    </style>
</head>
<body>
    <div class="wallet-container">
        <div class="wallet-header">
            <h3>Enviar Dinero</h3>
            <p>Disponible: <strong id="displayBalance" class="text-primary">...</strong></p>
        </div>

        <button class="btn btn-outline-primary w-100 mb-3" id="btnToggleAddContact">
            <i class="bi bi-person-plus"></i> Nuevo Contacto
        </button>

        <div id="addContactContainer" class="card p-3 mb-3 bg-light" style="display: none;">
            <form id="addContactForm">
                <input id="newNames" class="form-control mb-2" placeholder="Nombre completo" required>
                <input id="newAlias" class="form-control mb-2" placeholder="Alias" required>
                <input id="newBank" class="form-control mb-2" placeholder="Banco" required>
                <div class="d-flex gap-2">
                    <button type="submit" class="btn btn-sm btn-success flex-grow-1">Guardar</button>
                    <button type="button" id="btnCancelAdd" class="btn btn-sm btn-secondary">Cancelar</button>
                </div>
            </form>
        </div>

        <h6 class="text-muted">Selecciona un contacto:</h6>
        <div id="contactsList" class="mb-3" style="max-height: 200px; overflow-y: auto;">
            </div>

        <div id="sendForm" style="display: none;">
            <label class="form-label">Monto a transferir:</label>
            <div class="input-group mb-3">
                <span class="input-group-text">$</span>
                <input type="number" id="sendAmount" class="form-control" placeholder="0">
            </div>
            <button id="btnConfirmSend" class="btn btn-primary w-100 py-2">Transferir ahora</button>
        </div>

        <div id="alert-container" class="mt-3"></div>
        <a href="menu.html" class="btn btn-link w-100 mt-2 text-decoration-none">Volver al menú</a>
    </div>

    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="js/logic.js"></script>
    <script>
        $(document).ready(function() {
            let selectedContact = null;

            // --- Renderizar Contactos ---
            function renderContacts() {
                const contacts = getContacts();
                const container = $('#contactsList');
                container.empty();

                if (contacts.length === 0) {
                    container.html('<p class="text-muted text-center small">No tienes contactos guardados.</p>');
                    return;
                }

                contacts.forEach(c => {
                    container.append(`
                        <div class="card p-2 mb-2 contact-item">
                            <div class="d-flex justify-content-between">
                                <strong>${c.name}</strong>
                                <span class="badge bg-secondary">${c.bank}</span>
                            </div>
                            <small class="text-muted">Alias: ${c.alias}</small>
                        </div>
                    `);
                });
            }
            renderContacts();

            // --- UI: Mostrar/Ocultar formulario contacto ---
            $('#btnToggleAddContact').click(() => $('#addContactContainer').slideToggle());
            $('#btnCancelAdd').click(() => $('#addContactContainer').slideUp());

            // --- Guardar Contacto ---
            $('#addContactForm').submit(function(e) {
                e.preventDefault();
                saveContact({
                    name: $('#newNames').val(),
                    alias: $('#newAlias').val(),
                    bank: $('#newBank').val()
                });
                renderContacts(); // Refrescar lista
                $('#addContactContainer').slideUp();
                this.reset();
            });

            // --- Seleccionar Contacto ---
            $(document).on('click', '.contact-item', function() {
                $('.contact-item').removeClass('selected');
                $(this).addClass('selected');
                selectedContact = $(this).find('strong').text();
                $('#sendForm').slideDown(); // Mostrar input de monto
            });

            // --- Enviar Dinero ---
            $('#btnConfirmSend').click(function() {
                const amount = parseFloat($('#sendAmount').val());
                const currentBalance = getBalance();

                // Validaciones
                if (!amount || amount <= 0) {
                    alert("Ingresa un monto válido");
                    return;
                }
                if (amount > currentBalance) {
                    alert("Saldo insuficiente");
                    return;
                }

                // 1. Descontar saldo
                saveBalance(currentBalance - amount);
                
                // 2. Registrar transacción (¡CLAVE!)
                addTransaction('egreso', amount, `Transferencia a ${selectedContact}`);

                // 3. Feedback visual
                updateUIBalance();
                $('#sendForm').hide();
                $('#contactsList').hide();
                $('#alert-container').html(`
                    <div class="alert alert-success text-center">
                        <h4>¡Envío Exitoso!</h4>
                        <p>Has transferido ${formatMoney(amount)} a ${selectedContact}</p>
                        <a href="menu.html" class="btn btn-success btn-sm mt-2">Volver al Inicio</a>
                    </div>
                `);
            });
        });
    </script>
</body>
</html>